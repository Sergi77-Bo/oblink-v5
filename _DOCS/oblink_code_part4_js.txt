--- PART 4: JAVASCRIPT & SETUP ---
--- FILE: theme/js/header-auth.js ---
/**
 * OBLINK - Header Auth Dynamic
 * Makes the header react to Supabase authentication state
 */

document.addEventListener('DOMContentLoaded', async function () {
    const headerAuthActions = document.getElementById('header-auth-actions');

    if (!headerAuthActions) {
        console.warn('[Header Auth] Header auth actions container not found');
        return;
    }

    // Wait for Supabase to be ready
    if (!window.oblinkSupabase) {
        console.warn('[Header Auth] Supabase not loaded yet');
        return;
    }

    try {
        // Get current session
        const { data: { session }, error } = await window.oblinkSupabase.auth.getSession();

        if (error) {
            console.error('[Header Auth] Error getting session:', error);
            return;
        }

        if (session) {
            // USER IS LOGGED IN
            const user = session.user;
            const userType = user.user_metadata?.user_type;
            const firstName = user.user_metadata?.first_name || 'Utilisateur';
            const companyName = user.user_metadata?.company_name || 'Entreprise';

            // Determine dashboard URL (using window.location.origin)
            const baseUrl = window.location.origin;
            let dashboardPath = '/dashboard';
            let displayName = firstName;

            if (userType === 'opticien') {
                dashboardPath = '/dashboard-opticien';
                displayName = firstName;
            } else if (userType === 'entreprise') {
                dashboardPath = '/dashboard-entreprise';
                displayName = companyName;
            }

            const dashboardUrl = baseUrl + dashboardPath;

            console.log('[Header Auth] User type:', userType, 'Dashboard URL:', dashboardUrl);

            // Replace header content with logged-in state
            headerAuthActions.innerHTML = `
                <a href="${dashboardUrl}" 
                   class="px-4 py-2.5 bg-oblink-orange/10 text-oblink-orange rounded-lg font-bold hover:bg-oblink-orange hover:text-white transition flex items-center gap-2">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Mon Espace</span>
                </a>
                <button id="logout-btn"
                    class="px-5 py-2.5 bg-gray-100 text-oblink-gray rounded-lg font-bold hover:bg-gray-200 transition">
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    D√©connexion
                </button>
            `;

            // Logout handler
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    try {
                        await window.oblinkSupabase.auth.signOut();
                        window.location.href = baseUrl + '/';
                    } catch (err) {
                        console.error('[Header Auth] Logout error:', err);
                        alert('Erreur lors de la d√©connexion');
                    }
                });
            }

        } else {
            // USER IS NOT LOGGED IN - Keep default HTML (already in header-inc.php)
            console.log('[Header Auth] User not logged in, showing default state');
        }

    } catch (err) {
        console.error('[Header Auth] Unexpected error:', err);
    }
});
--- FILE: theme/js/supabase-config.js ---
// OBLINK - Supabase Configuration
// Handles initialization of the Supabase Client

// OBLINK - Supabase Configuration
// Handles initialization of the Supabase Client

// 1. Initialize Client IMMEDIATELY (Global Scope)
// This ensures window.oblinkSupabase is available before other scripts' DOMContentLoaded events fire.
if (typeof supabase === 'undefined') {
    console.error('Supabase SDK not loaded');
} else {
    const sbUrl = oblink_vars.supabase_url;
    const sbKey = oblink_vars.supabase_key;

    console.log('Supabase Init:', { url: sbUrl, keyLength: sbKey?.length });

    try {
        window.oblinkSupabase = supabase.createClient(sbUrl, sbKey);
        console.log("Supabase Client Initialized Successfully (Global)");
    } catch (err) {
        console.error("Supabase createClient Failed:", err);
    }
}

document.addEventListener('DOMContentLoaded', function () {
    // UI AUTH STATE MANAGEMENT
    // Check session on load
    updateAuthUI();

    // Listen for auth changes
    if (window.oblinkSupabase && window.oblinkSupabase.auth) {
        window.oblinkSupabase.auth.onAuthStateChange((event, session) => {
            console.log("Auth Event:", event);
            updateAuthUI(session);

            if (event === 'SIGNED_OUT') {
                // Optional: Redirect
            }
        });
    } else {
        console.error("Supabase Auth not available - Check Keys");
    }
});

async function updateAuthUI(session = null) {
    if (!window.oblinkSupabase || !window.oblinkSupabase.auth) return;

    try {
        if (!session) {
            const { data } = await window.oblinkSupabase.auth.getSession();
            session = data?.session;
        }
    } catch (err) {
        console.error("Error getting session:", err);
    }

    const authContainer = document.getElementById('header-auth-actions');
    const mobileAuthContainer = document.getElementById('mobile-auth-actions');

    if (session) {
        // USER LOGGED IN
        const user = session.user;
        const displayName = user.user_metadata.full_name || user.email;
        const initial = displayName.charAt(0).toUpperCase();

        // Determine Dashboard URL based on User Type
        const userType = user.user_metadata.user_type;
        const dashboardSlug = userType === 'entreprise' ? '/dashboard-entreprise' : '/dashboard-opticien';
        const dashboardUrl = (oblink_vars.home_url || '') + dashboardSlug;

        const html = `
            <a href="${dashboardUrl}" class="flex items-center space-x-2 text-sm font-semibold text-oblink-gray hover:text-oblink-orange">
                <div class="w-8 h-8 rounded-full bg-oblink-orange text-white flex items-center justify-center font-bold">
                    ${initial}
                </div>
                <span>Mon Espace</span>
            </a>
            <button onclick="oblinkSignOut()" class="text-xs text-gray-400 hover:text-red-500 ml-2">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        `;

        if (authContainer) authContainer.innerHTML = html;
        if (mobileAuthContainer) mobileAuthContainer.innerHTML = html; // Simplify for mobile for now
    } else {
        // USER LOGGED OUT
        const html = `
            <a href="/login" class="text-sm font-semibold text-oblink-gray hover:text-oblink-orange">Connexion</a>
            <a href="/inscription-opticien" class="px-5 py-2.5 bg-oblink-orange text-white rounded-lg font-bold shadow hover:bg-oblink-orange/90 transition transform hover:-translate-y-0.5">S'inscrire</a>
        `;

        if (authContainer) authContainer.innerHTML = html;
        if (mobileAuthContainer) mobileAuthContainer.innerHTML = html;
    }
}

async function oblinkSignOut() {
    const { error } = await window.oblinkSupabase.auth.signOut();
    if (!error) {
        window.location.href = '/login';
    } else {
        alert('Erreur d√©connexion: ' + error.message);
    }
}
--- FILE: theme/js/address-autocomplete.js ---
/**
 * OBLINK - Address Autocomplete Helper
 * Using French Government API: https://adresse.data.gouv.fr
 */

class AddressAutocomplete {
    constructor(inputId, options = {}) {
        this.input = document.getElementById(inputId);
        if (!this.input) {
            console.error(`[AddressAutocomplete] Input #${inputId} not found`);
            return;
        }

        this.options = {
            minChars: 3,
            debounceDelay: 300,
            limit: 5,
            onSelect: options.onSelect || (() => { }),
            ...options
        };

        this.suggestionsList = null;
        this.debounceTimer = null;
        this.selectedIndex = -1;

        this.init();
    }

    init() {
        // Create suggestions dropdown
        this.createSuggestionsUI();

        // Attach event listeners
        this.input.addEventListener('input', (e) => this.handleInput(e));
        this.input.addEventListener('keydown', (e) => this.handleKeyboard(e));
        this.input.addEventListener('blur', () => {
            setTimeout(() => this.hideSuggestions(), 200);
        });

        console.log('[AddressAutocomplete] Initialized for', this.input.id);
    }

    createSuggestionsUI() {
        // Create container
        this.suggestionsList = document.createElement('ul');
        this.suggestionsList.id = `${this.input.id}-suggestions`;
        this.suggestionsList.className = 'address-suggestions';
        this.suggestionsList.style.cssText = `
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: none;
            margin: 0;
            padding: 0;
            list-style: none;
        `;

        // Make input container relative
        this.input.parentElement.style.position = 'relative';
        this.input.parentElement.appendChild(this.suggestionsList);
    }

    handleInput(e) {
        const query = e.target.value.trim();

        if (query.length < this.options.minChars) {
            this.hideSuggestions();
            return;
        }

        // Debounce API calls
        clearTimeout(this.debounceTimer);
        this.debounceTimer = setTimeout(() => {
            this.searchAddresses(query);
        }, this.options.debounceDelay);
    }

    async searchAddresses(query) {
        try {
            const url = `https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(query)}&limit=${this.options.limit}`;
            const response = await fetch(url);
            const data = await response.json();

            if (data.features && data.features.length > 0) {
                this.displaySuggestions(data.features);
            } else {
                this.hideSuggestions();
            }
        } catch (error) {
            console.error('[AddressAutocomplete] Error fetching addresses:', error);
            this.hideSuggestions();
        }
    }

    displaySuggestions(features) {
        this.suggestionsList.innerHTML = '';
        this.selectedIndex = -1;

        features.forEach((feature, index) => {
            const li = document.createElement('li');
            li.className = 'address-suggestion-item';
            li.dataset.index = index;
            li.style.cssText = `
                padding: 0.75rem 1rem;
                cursor: pointer;
                border-bottom: 1px solid #f3f4f6;
                transition: background-color 0.15s;
            `;

            const props = feature.properties;
            li.innerHTML = `
                <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">
                    ${props.name || props.label}
                </div>
                <div style="font-size: 0.875rem; color: #6b7280;">
                    ${props.postcode} ${props.city} ${props.context ? '¬∑ ' + props.context : ''}
                </div>
            `;

            li.addEventListener('mouseenter', () => {
                this.selectSuggestion(index);
            });

            li.addEventListener('click', () => {
                this.applySuggestion(feature);
            });

            this.suggestionsList.appendChild(li);
        });

        this.suggestionsList.style.display = 'block';
    }

    selectSuggestion(index) {
        // Remove previous selection
        const items = this.suggestionsList.querySelectorAll('.address-suggestion-item');
        items.forEach(item => {
            item.style.backgroundColor = '';
        });

        // Apply new selection
        if (items[index]) {
            items[index].style.backgroundColor = '#f3f4f6';
            this.selectedIndex = index;
        }
    }

    handleKeyboard(e) {
        const items = this.suggestionsList.querySelectorAll('.address-suggestion-item');

        if (items.length === 0) return;

        switch (e.key) {
            case 'ArrowDown':
                e.preventDefault();
                this.selectedIndex = Math.min(this.selectedIndex + 1, items.length - 1);
                this.selectSuggestion(this.selectedIndex);
                break;

            case 'ArrowUp':
                e.preventDefault();
                this.selectedIndex = Math.max(this.selectedIndex - 1, 0);
                this.selectSuggestion(this.selectedIndex);
                break;

            case 'Enter':
                e.preventDefault();
                if (this.selectedIndex >= 0 && items[this.selectedIndex]) {
                    items[this.selectedIndex].click();
                }
                break;

            case 'Escape':
                this.hideSuggestions();
                break;
        }
    }

    applySuggestion(feature) {
        const props = feature.properties;

        // Fill input
        this.input.value = props.label;

        // Call callback with address data
        this.options.onSelect({
            label: props.label,
            name: props.name,
            street: props.street,
            postcode: props.postcode,
            city: props.city,
            context: props.context,
            coordinates: {
                lat: props.y,
                lng: props.x
            }
        });

        this.hideSuggestions();
    }

    hideSuggestions() {
        this.suggestionsList.style.display = 'none';
        this.selectedIndex = -1;
    }

    destroy() {
        if (this.suggestionsList) {
            this.suggestionsList.remove();
        }
    }
}

/**
 * Get user's current location
 */
async function getCurrentLocation() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            reject(new Error('G√©olocalisation non support√©e par votre navigateur'));
            return;
        }

        navigator.geolocation.getCurrentPosition(
            position => resolve({
                lat: position.coords.latitude,
                lng: position.coords.longitude
            }),
            error => {
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        reject(new Error('Permission de g√©olocalisation refus√©e'));
                        break;
                    case error.POSITION_UNAVAILABLE:
                        reject(new Error('Position indisponible'));
                        break;
                    case error.TIMEOUT:
                        reject(new Error('Timeout de g√©olocalisation'));
                        break;
                    default:
                        reject(new Error('Erreur de g√©olocalisation'));
                }
            },
            {
                timeout: 10000,
                enableHighAccuracy: true
            }
        );
    });
}

/**
 * Reverse geocode (coordinates -> address)
 */
async function reverseGeocode(lat, lng) {
    try {
        const url = `https://api-adresse.data.gouv.fr/reverse/?lon=${lng}&lat=${lat}`;
        const response = await fetch(url);
        const data = await response.json();

        if (data.features && data.features.length > 0) {
            const props = data.features[0].properties;
            return {
                label: props.label,
                name: props.name,
                street: props.street,
                postcode: props.postcode,
                city: props.city,
                context: props.context,
                coordinates: { lat, lng }
            };
        }

        throw new Error('Aucune adresse trouv√©e');
    } catch (error) {
        console.error('[reverseGeocode] Error:', error);
        throw error;
    }
}

/**
 * Add geolocation button to input
 */
function addGeolocationButton(inputId, onSuccess) {
    const input = document.getElementById(inputId);
    if (!input) return;

    const button = document.createElement('button');
    button.type = 'button';
    button.className = 'geolocation-btn';
    button.innerHTML = '<i class="fas fa-location-arrow"></i>';
    button.style.cssText = `
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
        color: white;
        border: none;
        border-radius: 0.5rem;
        width: 2.5rem;
        height: 2.5rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        box-shadow: 0 2px 4px rgba(255, 107, 53, 0.2);
    `;

    button.addEventListener('mouseenter', () => {
        button.style.transform = 'translateY(-50%) scale(1.05)';
        button.style.boxShadow = '0 4px 8px rgba(255, 107, 53, 0.3)';
    });

    button.addEventListener('mouseleave', () => {
        button.style.transform = 'translateY(-50%) scale(1)';
        button.style.boxShadow = '0 2px 4px rgba(255, 107, 53, 0.2)';
    });

    button.addEventListener('click', async () => {
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        button.disabled = true;

        try {
            const { lat, lng } = await getCurrentLocation();
            const address = await reverseGeocode(lat, lng);

            input.value = address.label;
            if (onSuccess) onSuccess(address);

            button.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => {
                button.innerHTML = '<i class="fas fa-location-arrow"></i>';
                button.disabled = false;
            }, 2000);
        } catch (error) {
            alert('‚ùå ' + error.message);
            button.innerHTML = '<i class="fas fa-location-arrow"></i>';
            button.disabled = false;
        }
    });

    input.parentElement.style.position = 'relative';
    input.parentElement.appendChild(button);
}

// Export for global use
window.AddressAutocomplete = AddressAutocomplete;
window.getCurrentLocation = getCurrentLocation;
window.reverseGeocode = reverseGeocode;
window.addGeolocationButton = addGeolocationButton;
--- FILE: theme/js/app.js ---
// OBLINK Advanced Frontend JavaScript

document.addEventListener('DOMContentLoaded', function () {
  console.log('üöÄ OBLINK Glassmorphism v3.1 with Blog initialized');

  // ===== BLOG FILTERS =====
  const filterButtons = document.querySelectorAll('.filter-btn');
  const articleCards = document.querySelectorAll('.article-card');

  if (filterButtons.length > 0) {
    filterButtons.forEach(button => {
      button.addEventListener('click', function () {
        const category = this.getAttribute('data-category');

        // Update active button
        filterButtons.forEach(btn => {
          btn.classList.remove('active');
          btn.classList.remove('bg-gradient-to-r', 'from-oblink-orange', 'to-oblink-violet', 'text-white');
          btn.classList.add('bg-white/60', 'backdrop-blur-xl', 'border', 'border-white/40', 'text-oblink-gray');
        });

        this.classList.add('active');
        this.classList.remove('bg-white/60', 'backdrop-blur-xl', 'border', 'border-white/40', 'text-oblink-gray');
        this.classList.add('bg-gradient-to-r', 'from-oblink-orange', 'to-oblink-violet', 'text-white');

        // Filter articles
        articleCards.forEach(card => {
          const cardCategory = card.getAttribute('data-category');

          if (category === 'all' || cardCategory === category) {
            card.style.display = 'block';
            setTimeout(() => {
              card.style.opacity = '1';
              card.style.transform = 'scale(1)';
            }, 50);
          } else {
            card.style.opacity = '0';
            card.style.transform = 'scale(0.95)';
            setTimeout(() => {
              card.style.display = 'none';
            }, 300);
          }
        });
      });
    });
  }

  // ===== 3D CAROUSEL =====
  const carousel = document.getElementById('processCarousel');
  const prevBtn = document.getElementById('carousel-prev');
  const nextBtn = document.getElementById('carousel-next');
  const indicators = document.querySelectorAll('.carousel-indicator');
  const items = document.querySelectorAll('.carousel-3d-item');

  let currentIndex = 0;
  let autoRotateInterval;
  const totalItems = items.length || 3;

  function updateCarousel() {
    items.forEach((item, index) => {
      item.classList.remove('active', 'prev', 'next');

      if (index === currentIndex) {
        item.classList.add('active');
      } else if (index === (currentIndex - 1 + totalItems) % totalItems) {
        item.classList.add('prev');
      } else if (index === (currentIndex + 1) % totalItems) {
        item.classList.add('next');
      }
    });

    // Update indicators
    indicators.forEach((indicator, index) => {
      if (index === currentIndex) {
        indicator.classList.add('active');
      } else {
        indicator.classList.remove('active');
      }
    });
  }

  function nextSlide() {
    currentIndex = (currentIndex + 1) % totalItems;
    updateCarousel();
  }

  function prevSlide() {
    currentIndex = (currentIndex - 1 + totalItems) % totalItems;
    updateCarousel();
  }

  function goToSlide(index) {
    currentIndex = index;
    updateCarousel();
  }

  // Event listeners
  if (nextBtn && prevBtn) {
    nextBtn.addEventListener('click', () => {
      nextSlide();
      resetAutoRotate();
    });

    prevBtn.addEventListener('click', () => {
      prevSlide();
      resetAutoRotate();
    });
  }

  // Indicator clicks
  indicators.forEach((indicator, index) => {
    indicator.addEventListener('click', () => {
      goToSlide(index);
      resetAutoRotate();
    });
  });

  // Auto rotate
  function startAutoRotate() {
    autoRotateInterval = setInterval(nextSlide, 8000); // Increased from 5s to 8s for better readability
  }

  function stopAutoRotate() {
    if (autoRotateInterval) {
      clearInterval(autoRotateInterval);
    }
  }

  function resetAutoRotate() {
    stopAutoRotate();
    startAutoRotate();
  }

  // Start auto-rotation when carousel is visible
  const carouselObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        startAutoRotate();
      } else {
        stopAutoRotate();
      }
    });
  }, { threshold: 0.5 });

  if (carousel) {
    carouselObserver.observe(carousel);
  }

  // Pause on hover
  if (carousel) {
    carousel.addEventListener('mouseenter', stopAutoRotate);
    carousel.addEventListener('mouseleave', startAutoRotate);
  }

  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft') {
      prevSlide();
      resetAutoRotate();
    } else if (e.key === 'ArrowRight') {
      nextSlide();
      resetAutoRotate();
    }
  });

  // Touch/Swipe support
  let touchStartX = 0;
  let touchEndX = 0;

  if (carousel) {
    carousel.addEventListener('touchstart', (e) => {
      touchStartX = e.changedTouches[0].screenX;
    }, { passive: true });

    carousel.addEventListener('touchend', (e) => {
      touchEndX = e.changedTouches[0].screenX;
      handleSwipe();
    }, { passive: true });
  }

  function handleSwipe() {
    const swipeThreshold = 50;
    const diff = touchStartX - touchEndX;

    if (Math.abs(diff) > swipeThreshold) {
      if (diff > 0) {
        // Swipe left - next
        nextSlide();
      } else {
        // Swipe right - prev
        prevSlide();
      }
      resetAutoRotate();
    }
  }

  // ===== MOBILE MENU =====
  const mobileMenuButton = document.getElementById('mobile-menu-button');
  const mobileMenu = document.getElementById('mobile-menu');

  if (mobileMenuButton && mobileMenu) {
    mobileMenuButton.addEventListener('click', function () {
      mobileMenu.classList.toggle('hidden');
      const icon = this.querySelector('i');
      if (mobileMenu.classList.contains('hidden')) {
        icon.className = 'fas fa-bars text-2xl';
      } else {
        icon.className = 'fas fa-times text-2xl';
      }
    });
  }

  // ===== SMOOTH SCROLL =====
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
      e.preventDefault();
      const target = document.querySelector(this.getAttribute('href'));
      if (target) {
        const navHeight = document.querySelector('nav').offsetHeight;
        const targetPosition = target.offsetTop - navHeight;

        window.scrollTo({
          top: targetPosition,
          behavior: 'smooth'
        });

        // Close mobile menu if open
        if (mobileMenu && !mobileMenu.classList.contains('hidden')) {
          mobileMenu.classList.add('hidden');
          const icon = mobileMenuButton.querySelector('i');
          icon.className = 'fas fa-bars text-2xl';
        }
      }
    });
  });

  // ===== LIQUID GLASS PARTICLES =====
  function createParticles(containerId, count = 20) {
    const container = document.getElementById(containerId);
    if (!container) return;

    for (let i = 0; i < count; i++) {
      const particle = document.createElement('div');
      particle.className = 'particle';
      particle.style.left = Math.random() * 100 + '%';
      particle.style.top = Math.random() * 100 + '%';
      particle.style.animationDelay = Math.random() * 15 + 's';
      particle.style.animationDuration = (10 + Math.random() * 10) + 's';
      container.appendChild(particle);
    }
  }

  // Create particles for testimonials section
  createParticles('particles-testimonials', 15);

  // ===== LIQUID GLASS CARD ANIMATIONS =====
  const liquidCards = document.querySelectorAll('.service-card-liquid, .testimonial-card-liquid');
  liquidCards.forEach((card, index) => {
    const delay = card.getAttribute('data-delay') || (index * 0.1);
    card.style.opacity = '0';
    card.style.transform = 'translateY(30px)';
    card.style.transition = `all 0.6s cubic-bezier(0.4, 0, 0.2, 1) ${delay}s`;
  });

  // ===== INTERSECTION OBSERVER FOR ANIMATIONS =====
  const observerOptions = {
    threshold: 0.1,
    rootMargin: '0px 0px -50px 0px'
  };

  const fadeInObserver = new IntersectionObserver(function (entries) {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.style.opacity = '1';
        entry.target.style.transform = 'translateY(0)';
        fadeInObserver.unobserve(entry.target);
      }
    });
  }, observerOptions);

  // Observe liquid cards
  liquidCards.forEach(card => fadeInObserver.observe(card));

  // Observe sections for fade-in
  document.querySelectorAll('section').forEach(section => {
    fadeInObserver.observe(section);
  });

  // ===== ANIMATED COUNTERS =====
  const counterObserver = new IntersectionObserver(function (entries) {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const counter = entry.target;
        // Parse target, handling both string '8.3' and numbers
        const targetAttr = counter.getAttribute('data-target');
        const target = parseFloat(targetAttr);

        // Determine if we need decimal formatting based on the input string or value
        // If data-target is "8.3", isDecimal is true. If "13300", false.
        const isDecimal = targetAttr.includes('.') || target % 1 !== 0;

        // Reset text content to 0 before starting (in case it wasn't)
        counter.textContent = isDecimal ? "0,0" : "0";

        console.log(`Starting counter animation for ${targetAttr}`);

        animateCounter(counter, 0, target, 2500, isDecimal);
        counterObserver.unobserve(counter);
      }
    });
  }, { threshold: 0.5 }); // Increased threshold to ensure visibility

  document.querySelectorAll('.counter').forEach(counter => {
    counterObserver.observe(counter);
  });

  function animateCounter(element, start, end, duration, isDecimal) {
    let startTimestamp = null;
    const step = (timestamp) => {
      if (!startTimestamp) startTimestamp = timestamp;
      const progress = Math.min((timestamp - startTimestamp) / duration, 1);

      // Easing function (easeOutExpo) for smoother animation
      // 1 - Math.pow(2, -10 * progress)
      const easeProgress = progress === 1 ? 1 : 1 - Math.pow(2, -10 * progress);

      const current = start + (easeProgress * (end - start));

      if (isDecimal) {
        element.textContent = current.toFixed(1).replace('.', ',');
      } else {
        element.textContent = Math.round(current).toLocaleString('fr-FR');
      }

      if (progress < 1) {
        window.requestAnimationFrame(step);
      } else {
        // Ensure final value is exact
        if (isDecimal) {
          element.textContent = end.toFixed(1).replace('.', ',');
        } else {
          element.textContent = Math.round(end).toLocaleString('fr-FR');
        }
      }
    };
    window.requestAnimationFrame(step);
  }

  // ===== PARALLAX EFFECT =====
  let ticking = false;

  function updateParallax() {
    const scrolled = window.pageYOffset;
    const hero = document.getElementById('hero');

    if (hero && scrolled < window.innerHeight) {
      const shapes = hero.querySelectorAll('.floating-shape');
      shapes.forEach((shape, index) => {
        const speed = 0.5 + (index * 0.1);
        const yPos = scrolled * speed;
        shape.style.transform = `translate3d(0, ${yPos}px, 0)`;
      });
    }

    ticking = false;
  }

  window.addEventListener('scroll', function () {
    if (!ticking) {
      window.requestAnimationFrame(updateParallax);
      ticking = true;
    }
  });

  // ===== NAVBAR SHADOW ON SCROLL =====
  const navbar = document.getElementById('navbar');

  window.addEventListener('scroll', function () {
    if (window.scrollY > 50) {
      navbar.classList.add('shadow-lg');
      navbar.style.background = 'rgba(255, 255, 255, 0.98)';
    } else {
      navbar.classList.remove('shadow-lg');
      navbar.style.background = 'rgba(255, 255, 255, 0.95)';
    }
  });

  // ===== CTA CARD HOVER EFFECT =====
  const ctaCards = document.querySelectorAll('.cta-card');

  ctaCards.forEach(card => {
    card.addEventListener('mouseenter', function () {
      this.style.transform = 'scale(1.02)';
    });

    card.addEventListener('mouseleave', function () {
      this.style.transform = 'scale(1)';
    });
  });

  // ===== MOUSE TRAIL EFFECT =====
  let mouseX = 0;
  let mouseY = 0;
  let cursorDot, cursorOutline;

  function createCursor() {
    cursorDot = document.createElement('div');
    cursorDot.style.cssText = `
      width: 8px;
      height: 8px;
      background: #FF6600;
      border-radius: 50%;
      position: fixed;
      pointer-events: none;
      z-index: 9999;
      transition: transform 0.1s;
      display: none;
    `;

    cursorOutline = document.createElement('div');
    cursorOutline.style.cssText = `
      width: 32px;
      height: 32px;
      border: 2px solid rgba(255, 102, 0, 0.3);
      border-radius: 50%;
      position: fixed;
      pointer-events: none;
      z-index: 9998;
      transition: all 0.15s ease;
      display: none;
    `;

    document.body.appendChild(cursorDot);
    document.body.appendChild(cursorOutline);

    // Only show on desktop
    if (window.innerWidth > 768) {
      cursorDot.style.display = 'block';
      cursorOutline.style.display = 'block';
    }
  }

  createCursor();

  document.addEventListener('mousemove', function (e) {
    mouseX = e.clientX;
    mouseY = e.clientY;

    if (cursorDot && cursorOutline) {
      cursorDot.style.left = mouseX - 4 + 'px';
      cursorDot.style.top = mouseY - 4 + 'px';

      cursorOutline.style.left = mouseX - 16 + 'px';
      cursorOutline.style.top = mouseY - 16 + 'px';
    }
  });

  // Cursor hover effect on clickable elements
  const clickables = document.querySelectorAll('a, button, .cta-card');
  clickables.forEach(el => {
    el.addEventListener('mouseenter', () => {
      if (cursorOutline) {
        cursorOutline.style.transform = 'scale(1.5)';
        cursorOutline.style.borderColor = 'rgba(255, 102, 0, 0.5)';
      }
    });

    el.addEventListener('mouseleave', () => {
      if (cursorOutline) {
        cursorOutline.style.transform = 'scale(1)';
        cursorOutline.style.borderColor = 'rgba(255, 102, 0, 0.3)';
      }
    });
  });

  // ===== FORM VALIDATION =====
  const forms = document.querySelectorAll('form[data-validate]');
  forms.forEach(form => {
    form.addEventListener('submit', function (e) {
      e.preventDefault();

      let isValid = true;
      const requiredFields = form.querySelectorAll('[required]');

      requiredFields.forEach(field => {
        if (!field.value.trim()) {
          isValid = false;
          field.classList.add('border-red-500');
          field.classList.add('shake');
          setTimeout(() => field.classList.remove('shake'), 500);
        } else {
          field.classList.remove('border-red-500');
        }
      });

      if (isValid) {
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Envoi en cours...';
        }

        setTimeout(() => {
          showNotification('Formulaire envoy√© avec succ√®s !', 'success');
          form.reset();
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Envoyer';
          }
        }, 1500);
      } else {
        showNotification('Veuillez remplir tous les champs obligatoires', 'error');
      }
    });
  });

  // ===== NOTIFICATION SYSTEM =====
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';

    notification.className = `fixed top-24 right-4 ${bgColor} text-white px-6 py-4 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300`;
    notification.innerHTML = `
      <div class="flex items-center">
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} mr-3"></i>
        <span>${message}</span>
      </div>
    `;

    document.body.appendChild(notification);

    setTimeout(() => {
      notification.style.transform = 'translateX(0)';
    }, 100);

    setTimeout(() => {
      notification.style.transform = 'translateX(calc(100% + 2rem))';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }

  // ===== CTA TRACKING =====
  const ctaButtons = document.querySelectorAll('a[href*="register"], a[href*="inscription"], a[href*="opticiens"], a[href*="entreprises"]');
  ctaButtons.forEach(btn => {
    btn.addEventListener('click', function (e) {
      const action = this.href.includes('opticien') ? 'Opticien CTA' : 'Entreprise CTA';
      console.log('üìä CTA clicked:', action, this.href);
      // Here you would send to analytics
      // gtag('event', 'cta_click', { action: action });
    });
  });

  // ===== LAZY LOADING IMAGES =====
  if ('IntersectionObserver' in window) {
    const imageObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target;
          img.src = img.dataset.src;
          img.classList.remove('lazy');
          imageObserver.unobserve(img);
        }
      });
    });

    document.querySelectorAll('img.lazy').forEach(img => {
      imageObserver.observe(img);
    });
  }

  // ===== DYNAMIC YEAR IN FOOTER =====
  const yearElements = document.querySelectorAll('.current-year');
  const currentYear = new Date().getFullYear();
  yearElements.forEach(el => {
    el.textContent = currentYear;
  });

  // ===== PARTICLE EFFECT ON HERO =====
  function createParticles() {
    const hero = document.getElementById('hero');
    if (!hero || window.innerWidth < 768) return;

    for (let i = 0; i < 20; i++) {
      const particle = document.createElement('div');
      particle.className = 'particle';
      particle.style.cssText = `
        position: absolute;
        width: ${Math.random() * 4 + 2}px;
        height: ${Math.random() * 4 + 2}px;
        background: rgba(255, 102, 0, ${Math.random() * 0.5 + 0.2});
        border-radius: 50%;
        left: ${Math.random() * 100}%;
        top: ${Math.random() * 100}%;
        animation: float ${Math.random() * 10 + 10}s infinite ease-in-out;
        animation-delay: ${Math.random() * 5}s;
      `;
      hero.appendChild(particle);
    }
  }

  createParticles();

  // ===== RESIZE HANDLER =====
  let resizeTimer;
  window.addEventListener('resize', function () {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
      if (window.innerWidth > 768) {
        if (cursorDot) cursorDot.style.display = 'block';
        if (cursorOutline) cursorOutline.style.display = 'block';
      } else {
        if (cursorDot) cursorDot.style.display = 'none';
        if (cursorOutline) cursorOutline.style.display = 'none';
      }
    }, 250);
  });
  // ===== MESSAGING SYSTEM (V62) =====
  const conversationList = document.getElementById('conversation-list');
  const chatMessages = document.getElementById('chat-messages');
  const chatInputArea = document.getElementById('chat-input-area');
  const currentContactIdInput = document.getElementById('current-contact-id');
  const sendMessageForm = document.getElementById('send-message-form');

  if (conversationList) {
    // 1. CLICK CONVERSATION
    conversationList.addEventListener('click', function (e) {
      const item = e.target.closest('.conversation-item');
      if (!item) return;

      // Enhance UI active state
      document.querySelectorAll('.conversation-item').forEach(el => el.classList.remove('bg-blue-50', 'border-l-4', 'border-oblink-blue'));
      item.classList.add('bg-blue-50', 'border-l-4', 'border-oblink-blue');

      const contactId = item.getAttribute('data-contact-id');
      currentContactIdInput.value = contactId;
      chatInputArea.classList.remove('hidden');

      // Load Messages AJAX
      chatMessages.innerHTML = '<div class="flex h-full items-center justify-center text-gray-400"><i class="fas fa-spinner fa-spin text-2xl"></i></div>';

      const formData = new FormData();
      formData.append('action', 'oblink_load_chat');
      formData.append('contact_id', contactId);
      formData.append('nonce', oblink_vars.nonce);

      fetch(oblink_vars.ajax_url + '?action=oblink_load_chat&contact_id=' + contactId + '&nonce=' + oblink_vars.nonce)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            chatMessages.innerHTML = data.data.html || '<div class="text-center text-xs text-gray-400 mt-10">D√©but de la conversation</div>';
            chatMessages.scrollTop = chatMessages.scrollHeight;
          } else {
            chatMessages.innerHTML = '<div class="text-red-500 text-center">Erreur chargement</div>';
          }
        });
    });

    // 2. SEND MESSAGE
    if (sendMessageForm) {
      sendMessageForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const contactId = currentContactIdInput.value;
        const messageInput = document.getElementById('message-input');
        const message = messageInput.value.trim();

        if (!message) return;

        // Optimistic UI update
        const tempMsg = document.createElement('div');
        tempMsg.className = 'flex justify-end mb-4 opacity-50';
        tempMsg.innerHTML = `<div class="bg-oblink-blue text-white rounded-2xl py-2 px-4 max-w-[80%] text-sm">${message}</div>`;
        chatMessages.appendChild(tempMsg);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        messageInput.value = '';

        const formData = new FormData();
        formData.append('action', 'oblink_send_msg');
        formData.append('receiver_id', contactId);
        formData.append('message', message);
        formData.append('nonce', oblink_vars.nonce);

        fetch(oblink_vars.ajax_url, {
          method: 'POST',
          body: formData
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              tempMsg.classList.remove('opacity-50');
            } else {
              tempMsg.classList.add('bg-red-500');
              alert('Erreur envoi');
            }
          });
      });
    }
  }
  const OBLINK = {
    async fetchStats() {
      try {
        const response = await fetch('/api/stats');
        const data = await response.json();
        return data;
      } catch (error) {
        console.error('Error fetching stats:', error);
        return null;
      }
    },

    async submitContact(formData) {
      try {
        const response = await fetch('/api/contact', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData)
        });
        return await response.json();
      } catch (error) {
        console.error('Error submitting contact:', error);
        return { error: 'Une erreur est survenue' };
      }
    }
  };

  // Make OBLINK API available globally
  window.OBLINK = OBLINK;

  // ===== CSS ANIMATIONS HELPER =====
  const style = document.createElement('style');
  style.textContent = `
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-10px); }
    75% { transform: translateX(10px); }
  }
  
  .shake {
    animation: shake 0.5s;
  }
`;
  document.head.appendChild(style);
});
